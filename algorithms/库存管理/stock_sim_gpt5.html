<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åº“å­˜ç®¡ç†å¯è§†åŒ–ä»¿çœŸ</title>
  <!-- TailwindCSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    html, body { height: 100%; }
    .stat { @apply p-4 bg-white rounded-2xl shadow; }
    .card { @apply p-4 bg-white rounded-2xl shadow; }
    .label { @apply text-sm text-gray-600; }
    .input { @apply w-full border border-gray-300 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400; }
    .section-title { @apply text-lg font-semibold text-gray-800; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold">ğŸ“¦ åº“å­˜ç®¡ç†å¯è§†åŒ–ä»¿çœŸ</h1>
      <p class="text-gray-600 mt-1">æ”¯æŒ (s, S) è¿ç»­è¡¥è´§ã€(s, Q) å›ºå®šè®¢è´§é‡ã€å‘¨æœŸå¤ç›˜ (R, S) ä¸‰ç§ç­–ç•¥ï¼›å¯é…ç½®éœ€æ±‚åˆ†å¸ƒã€æå‰æœŸã€æˆæœ¬å‚æ•°ç­‰ã€‚</p>
    </header>

    <!-- æ§åˆ¶å° -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <div class="lg:col-span-1 space-y-4">
        <div class="card space-y-3">
          <div class="section-title">åŸºç¡€å‚æ•°</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="label col-span-1">æ¨¡æ‹Ÿå¤©æ•°
              <input id="days" type="number" class="input" value="180" min="1" />
            </label>
            <label class="label col-span-1">åˆå§‹åº“å­˜
              <input id="initInv" type="number" class="input" value="200" min="0" />
            </label>
            <label class="label col-span-1">éšæœºç§å­
              <input id="seed" type="number" class="input" value="42" />
            </label>
            <label class="label col-span-1">å•ä½
              <input id="uom" type="text" class="input" value="ä»¶" />
            </label>
          </div>
        </div>

        <div class="card space-y-3">
          <div class="section-title">éœ€æ±‚åˆ†å¸ƒ</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="label col-span-2">
              åˆ†å¸ƒç±»å‹
              <select id="demandDist" class="input">
                <option value="poisson">æ³Šæ¾ (æ•´æ•°)</option>
                <option value="normal">æ­£æ€ (æˆªæ–­åˆ°â‰¥0)</option>
              </select>
            </label>
            <label class="label col-span-1">å‡å€¼ Î¼/Î»
              <input id="demandMean" type="number" class="input" value="50" step="0.1" />
            </label>
            <label class="label col-span-1">æ ‡å‡†å·® Ïƒ
              <input id="demandStd" type="number" class="input" value="15" step="0.1" />
            </label>
          </div>
          <p class="text-xs text-gray-500">æ³Šæ¾åˆ†å¸ƒä»…ä½¿ç”¨å‡å€¼ï¼›æ­£æ€åˆ†å¸ƒä½¿ç”¨å‡å€¼ä¸æ ‡å‡†å·®ï¼Œå¹¶æˆªæ–­ä¸ºéè´Ÿæ•´æ•°ã€‚</p>
        </div>

        <div class="card space-y-3">
          <div class="section-title">æå‰æœŸï¼ˆLead Timeï¼‰</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="label col-span-1">å‡å€¼ï¼ˆå¤©ï¼‰
              <input id="ltMean" type="number" class="input" value="5" step="0.1" />
            </label>
            <label class="label col-span-1">æ ‡å‡†å·®ï¼ˆå¤©ï¼‰
              <input id="ltStd" type="number" class="input" value="1" step="0.1" />
            </label>
            <label class="label col-span-2">æœ€å°æå‰æœŸï¼ˆå¤©ï¼‰
              <input id="ltMin" type="number" class="input" value="1" min="0" />
            </label>
          </div>
          <p class="text-xs text-gray-500">ä½¿ç”¨æˆªæ–­æ­£æ€åˆ†å¸ƒå–æ•´ï¼Œä¸” â‰¥ æœ€å°æå‰æœŸã€‚</p>
        </div>

        <div class="card space-y-3">
          <div class="section-title">ç­–ç•¥ä¸å‚æ•°</div>
          <label class="label">ç­–ç•¥é€‰æ‹©
            <select id="policy" class="input">
              <option value="sS">(s, S) è¿ç»­è¡¥è´§</option>
              <option value="sQ">(s, Q) å›ºå®šè®¢è´§é‡</option>
              <option value="RS">(R, S) å‘¨æœŸå¤ç›˜</option>
            </select>
          </label>

          <!-- s,S -->
          <div id="panel-sS" class="grid grid-cols-2 gap-3 policy-panel">
            <label class="label">sï¼ˆå†è®¢è´§ç‚¹ï¼‰
              <input id="s_val" type="number" class="input" value="120" />
            </label>
            <label class="label">Sï¼ˆè®¢è´§è‡³ï¼‰
              <input id="S_val" type="number" class="input" value="300" />
            </label>
          </div>

          <!-- s,Q -->
          <div id="panel-sQ" class="grid grid-cols-2 gap-3 policy-panel hidden">
            <label class="label">sï¼ˆå†è®¢è´§ç‚¹ï¼‰
              <input id="s_val_Q" type="number" class="input" value="120" />
            </label>
            <label class="label">Qï¼ˆæ¯æ¬¡è®¢è´§é‡ï¼‰
              <input id="Q_val" type="number" class="input" value="180" />
            </label>
          </div>

          <!-- R,S -->
          <div id="panel-RS" class="grid grid-cols-2 gap-3 policy-panel hidden">
            <label class="label">Rï¼ˆå¤ç›˜å‘¨æœŸï¼Œå¤©ï¼‰
              <input id="R_val" type="number" class="input" value="7" />
            </label>
            <label class="label">Sï¼ˆè®¢è´§è‡³ï¼‰
              <input id="S_val_RS" type="number" class="input" value="350" />
            </label>
          </div>
        </div>

        <div class="card space-y-3">
          <div class="section-title">æˆæœ¬å‚æ•°</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="label">å•ä½æŒæœ‰æˆæœ¬/å¤©
              <input id="cHold" type="number" class="input" value="0.1" step="0.01" />
            </label>
            <label class="label">æ¯æ¬¡ä¸‹å•å›ºå®šæˆæœ¬
              <input id="cOrderFix" type="number" class="input" value="50" step="0.01" />
            </label>
            <label class="label">ä¸‹å•å•ä½æˆæœ¬
              <input id="cOrderUnit" type="number" class="input" value="0" step="0.01" />
            </label>
            <label class="label">ç¼ºè´§æƒ©ç½š/å•ä½
              <input id="cShort" type="number" class="input" value="5" step="0.01" />
            </label>
          </div>
        </div>

        <div class="card flex flex-wrap gap-3">
          <button id="btnExample" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl">ç¤ºä¾‹å‚æ•°</button>
          <button id="btnRun" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl">å¼€å§‹ä»¿çœŸ</button>
          <button id="btnReset" class="px-4 py-2 bg-white border rounded-xl">é‡ç½®</button>
          <button id="btnExport" class="ml-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl">å¯¼å‡ºCSV</button>
        </div>
      </div>

      <!-- å³ä¾§å¯è§†åŒ– -->
      <div class="lg:col-span-2 space-y-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="stat">
            <div class="text-gray-500 text-sm">æ€»éœ€æ±‚</div>
            <div id="stat-demand" class="text-2xl font-semibold">â€”</div>
          </div>
          <div class="stat">
            <div class="text-gray-500 text-sm">å‘è´§é‡ / ç¼ºè´§é‡</div>
            <div class="text-2xl font-semibold"><span id="stat-ship">â€”</span> / <span id="stat-short">â€”</span></div>
          </div>
          <div class="stat">
            <div class="text-gray-500 text-sm">å¡«å……ç‡ï¼ˆFill Rateï¼‰</div>
            <div id="stat-fill" class="text-2xl font-semibold">â€”</div>
          </div>
          <div class="stat">
            <div class="text-gray-500 text-sm">å¹³å‡åº“å­˜ / è®¢å•æ•°</div>
            <div class="text-2xl font-semibold"><span id="stat-avgInv">â€”</span> / <span id="stat-orders">â€”</span></div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center gap-3 mb-3">
            <div class="section-title">åº“å­˜è½¨è¿¹</div>
            <span class="text-xs text-gray-500">çºµè½´ï¼šæœŸæœ«åœ¨æ‰‹åº“å­˜ï¼›ç‚¹æ ‡è®°ï¼šä¸‹å•ä¸åˆ°è´§</span>
          </div>
          <canvas id="invChart" height="140"></canvas>
        </div>

        <div class="card">
          <div class="section-title mb-2">æˆæœ¬åˆ†è§£</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="stat">
              <div class="text-gray-500 text-sm">æŒæœ‰æˆæœ¬</div>
              <div id="cost-hold" class="text-xl font-semibold">â€”</div>
            </div>
            <div class="stat">
              <div class="text-gray-500 text-sm">ä¸‹å•å›ºå®šæˆæœ¬</div>
              <div id="cost-orderfix" class="text-xl font-semibold">â€”</div>
            </div>
            <div class="stat">
              <div class="text-gray-500 text-sm">ä¸‹å•å•ä½æˆæœ¬</div>
              <div id="cost-orderunit" class="text-xl font-semibold">â€”</div>
            </div>
            <div class="stat">
              <div class="text-gray-500 text-sm">ç¼ºè´§æƒ©ç½š</div>
              <div id="cost-short" class="text-xl font-semibold">â€”</div>
            </div>
          </div>
          <div class="mt-3 text-right text-lg font-bold">æ€»æˆæœ¬ï¼š<span id="cost-total">â€”</span></div>
        </div>

        <div class="card overflow-auto">
          <div class="section-title mb-2">äº‹ä»¶æ—¥å¿—ï¼ˆæœ€è¿‘ 200 æ¡ï¼‰</div>
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 text-left">å¤©</th>
                <th class="p-2 text-left">éœ€æ±‚</th>
                <th class="p-2 text-left">å‘è´§</th>
                <th class="p-2 text-left">ç¼ºè´§</th>
                <th class="p-2 text-left">åˆ°è´§</th>
                <th class="p-2 text-left">ä¸‹å•</th>
                <th class="p-2 text-left">æœŸæœ«åº“å­˜</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="text-xs text-gray-500 mt-8 text-center">Â© ä»¿çœŸä»…ç”¨äºæ•™å­¦/æ–¹æ¡ˆè¯„ä¼°ã€‚å»ºè®®ç»“åˆå†å²æ•°æ®åšå‚æ•°æ ¡å‡†ä¸æƒ…æ™¯åˆ†æã€‚</footer>
  </div>

  <script>
    // ------------------- å·¥å…·å‡½æ•°ï¼ˆéšæœºæ•°ã€åˆ†å¸ƒç­‰ï¼‰ -------------------
    function mulberry32(a) {
      return function () {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    function randn_bm(u) {
      // Box-Muller transform: returns standard normal
      let u1 = 0, u2 = 0;
      // Convert [0,1) to (0,1)
      u1 = Math.max(u(), Number.EPSILON);
      u2 = Math.max(u(), Number.EPSILON);
      const R = Math.sqrt(-2.0 * Math.log(u1));
      const theta = 2.0 * Math.PI * u2;
      return R * Math.cos(theta);
    }

    function poisson(lambda, u) {
      // Knuth algorithm â€” OK for small/medium lambda in daily demand
      const L = Math.exp(-lambda);
      let p = 1.0, k = 0;
      do {
        k++;
        p *= u();
      } while (p > L);
      return k - 1;
    }

    function truncNormalInt(mean, std, u) {
      if (std <= 0) return Math.max(0, Math.round(mean));
      const z = randn_bm(u);
      const val = mean + std * z;
      return Math.max(0, Math.round(val));
    }

    function truncNormalIntMin(mean, std, minVal, u) {
      // for lead time (>= minVal)
      if (std <= 0) return Math.max(minVal, Math.round(mean));
      const z = randn_bm(u);
      const val = mean + std * z;
      return Math.max(minVal, Math.round(val));
    }

    // ------------------- ä»¿çœŸä¸»ä½“ -------------------
    function simulate(params) {
      const {
        days, initInv, seed,
        demandDist, demandMean, demandStd,
        ltMean, ltStd, ltMin,
        policy,
        s, S, s_Q, Q, R, S_RS,
        cHold, cOrderFix, cOrderUnit, cShort
      } = params;

      const rng = mulberry32(seed >>> 0);

      // pipeline: {arriveDay, qty}
      const pipeline = [];
      const logs = [];

      let onHand = Math.max(0, initInv | 0);
      let totalDemand = 0;
      let totalShip = 0;
      let totalShort = 0;
      let totalHoldCost = 0;
      let totalOrderFixCost = 0;
      let totalOrderUnitCost = 0;
      let totalShortCost = 0;
      let orderCount = 0;
      let orderUnits = 0;

      const daysArr = [];
      const invSeries = [];
      const orderPlaceX = [], orderPlaceY = [];
      const receiptX = [], receiptY = [];

      function position() {
        const pipeQty = pipeline.reduce((acc, o) => acc + o.qty, 0);
        return onHand + pipeQty;
      }

      function placeOrder(qty, day) {
        const lt = truncNormalIntMin(ltMean, ltStd, ltMin, rng);
        const arrive = day + Math.max(0, lt);
        pipeline.push({ arriveDay: arrive, qty: qty });
        orderCount += 1;
        orderUnits += qty;
        totalOrderFixCost += cOrderFix;
        totalOrderUnitCost += cOrderUnit * qty;
        orderPlaceX.push(day);
        orderPlaceY.push(onHand);
      }

      for (let day = 1; day <= days; day++) {
        // 1) åˆ°è´§
        let receiveQty = 0;
        for (let i = pipeline.length - 1; i >= 0; i--) {
          const o = pipeline[i];
          if (o.arriveDay === day) {
            onHand += o.qty;
            receiveQty += o.qty;
            receiptX.push(day);
            receiptY.push(onHand);
            pipeline.splice(i, 1);
          }
        }

        // 2) éœ€æ±‚å‘ç”Ÿ
        let demand = 0;
        if (demandDist === 'poisson') {
          demand = poisson(Math.max(0, demandMean), rng);
        } else {
          demand = truncNormalInt(Math.max(0, demandMean), Math.max(0, demandStd), rng);
        }
        const ship = Math.min(onHand, demand);
        const short = Math.max(0, demand - ship);
        onHand -= ship;

        totalDemand += demand;
        totalShip += ship;
        totalShort += short;
        totalShortCost += short * cShort;

        // 3) å†³ç­–ä¸‹å•ï¼ˆæŒ‰ç­–ç•¥ï¼‰
        const pos = position();
        if (policy === 'sS') {
          if (pos <= s) {
            const qty = Math.max(0, S - pos);
            if (qty > 0) placeOrder(qty, day);
          }
        } else if (policy === 'sQ') {
          if (pos <= s_Q) {
            const qty = Math.max(0, Q);
            if (qty > 0) placeOrder(qty, day);
          }
        } else if (policy === 'RS') {
          if (R > 0 && day % R === 0) {
            const qty = Math.max(0, S_RS - pos);
            if (qty > 0) placeOrder(qty, day);
          }
        }

        // 4) æœŸæœ«æŒæœ‰æˆæœ¬
        totalHoldCost += onHand * cHold;

        // 5) è®°å½•
        daysArr.push(day);
        invSeries.push(onHand);
        logs.push({ day, demand, ship, short, receive: receiveQty, order: (orderPlaceX.at(-1) === day ? orderPlaceY.at(-1) : 0), invEnd: onHand });
      }

      const avgInv = invSeries.reduce((a, b) => a + b, 0) / (invSeries.length || 1);
      const fillRate = totalDemand > 0 ? totalShip / totalDemand : 1;

      return {
        daysArr, invSeries,
        orderPlaceX, orderPlaceY,
        receiptX, receiptY,
        totalDemand, totalShip, totalShort,
        avgInv, orderCount, orderUnits,
        totalHoldCost, totalOrderFixCost, totalOrderUnitCost, totalShortCost,
        totalCost: totalHoldCost + totalOrderFixCost + totalOrderUnitCost + totalShortCost,
        logs
      };
    }

    // ------------------- UI/äº¤äº’ -------------------
    const el = id => document.getElementById(id);

    const panels = {
      sS: el('panel-sS'),
      sQ: el('panel-sQ'),
      RS: el('panel-RS'),
    };

    el('policy').addEventListener('change', () => {
      const v = el('policy').value;
      Object.keys(panels).forEach(k => panels[k].classList.add('hidden'));
      panels[v]?.classList.remove('hidden');
    });

    el('btnReset').addEventListener('click', () => {
      el('days').value = 180;
      el('initInv').value = 200;
      el('seed').value = 42;
      el('uom').value = 'ä»¶';
      el('demandDist').value = 'poisson';
      el('demandMean').value = 50;
      el('demandStd').value = 15;
      el('ltMean').value = 5;
      el('ltStd').value = 1;
      el('ltMin').value = 1;
      el('policy').value = 'sS';
      el('s_val').value = 120;
      el('S_val').value = 300;
      el('s_val_Q').value = 120;
      el('Q_val').value = 180;
      el('R_val').value = 7;
      el('S_val_RS').value = 350;
      Object.keys(panels).forEach(k => panels[k].classList.add('hidden'));
      panels['sS'].classList.remove('hidden');
      clearOutputs();
    });

    el('btnExample').addEventListener('click', () => {
      // ç¤ºä¾‹ä¸€é”®å¡«å……ï¼šè¾ƒé«˜ä¸ç¡®å®šæ€§ & å‘¨æœŸå¤ç›˜ç­–ç•¥
      el('demandDist').value = 'normal';
      el('demandMean').value = 60;
      el('demandStd').value = 20;
      el('ltMean').value = 6;
      el('ltStd').value = 2;
      el('ltMin').value = 1;
      el('policy').value = 'RS';
      Object.keys(panels).forEach(k => panels[k].classList.add('hidden'));
      panels['RS'].classList.remove('hidden');
      el('R_val').value = 7;
      el('S_val_RS').value = 420;
    });

    let chart;
    function renderChart(data, uom) {
      const ctx = el('invChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.daysArr,
          datasets: [
            {
              label: `åœ¨æ‰‹åº“å­˜ï¼ˆ${uom}ï¼‰`,
              data: data.invSeries,
              borderWidth: 2,
              tension: 0.2,
              pointRadius: 0,
            },
            {
              type: 'scatter',
              label: 'ä¸‹å•äº‹ä»¶',
              data: data.orderPlaceX.map((x,i) => ({x, y: data.orderPlaceY[i]})),
              pointRadius: 4,
            },
            {
              type: 'scatter',
              label: 'åˆ°è´§äº‹ä»¶',
              data: data.receiptX.map((x,i) => ({x, y: data.receiptY[i]})),
              pointRadius: 4,
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'nearest', intersect: false }
          },
          scales: {
            x: { title: { display: true, text: 'å¤©æ•°' } },
            y: { title: { display: true, text: `åº“å­˜ï¼ˆ${uom}ï¼‰` }, beginAtZero: true }
          }
        }
      });
    }

    function fmt(n) { return Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 }); }

    function clearOutputs() {
      el('stat-demand').textContent = 'â€”';
      el('stat-ship').textContent = 'â€”';
      el('stat-short').textContent = 'â€”';
      el('stat-fill').textContent = 'â€”';
      el('stat-avgInv').textContent = 'â€”';
      el('stat-orders').textContent = 'â€”';
      el('cost-hold').textContent = 'â€”';
      el('cost-orderfix').textContent = 'â€”';
      el('cost-orderunit').textContent = 'â€”';
      el('cost-short').textContent = 'â€”';
      el('cost-total').textContent = 'â€”';
      el('logBody').innerHTML = '';
      if (chart) chart.destroy();
    }

    function readParams() {
      return {
        days: +el('days').value,
        initInv: +el('initInv').value,
        seed: +el('seed').value,
        demandDist: el('demandDist').value,
        demandMean: +el('demandMean').value,
        demandStd: +el('demandStd').value,
        ltMean: +el('ltMean').value,
        ltStd: +el('ltStd').value,
        ltMin: +el('ltMin').value,
        policy: el('policy').value,
        s: +el('s_val').value,
        S: +el('S_val').value,
        s_Q: +el('s_val_Q').value,
        Q: +el('Q_val').value,
        R: +el('R_val').value,
        S_RS: +el('S_val_RS').value,
        cHold: +el('cHold').value,
        cOrderFix: +el('cOrderFix').value,
        cOrderUnit: +el('cOrderUnit').value,
        cShort: +el('cShort').value,
        uom: el('uom').value || 'ä»¶'
      };
    }

    el('btnRun').addEventListener('click', () => {
      const p = readParams();
      // åŸºæœ¬æ ¡éªŒ
      if (p.days <= 0) return alert('æ¨¡æ‹Ÿå¤©æ•°å¿…é¡» > 0');
      if (p.policy === 'sS' && p.S < p.s) return alert('S åº” â‰¥ s');
      if (p.policy === 'RS' && p.R <= 0) return alert('R å‘¨æœŸå¿…é¡» > 0');

      const result = simulate(p);

      // KPI è¾“å‡º
      el('stat-demand').textContent = fmt(result.totalDemand) + ' ' + p.uom;
      el('stat-ship').textContent = fmt(result.totalShip);
      el('stat-short').textContent = fmt(result.totalShort);
      el('stat-fill').textContent = (result.fillRate * 100).toFixed(1) + '%';
      el('stat-avgInv').textContent = fmt(result.avgInv);
      el('stat-orders').textContent = fmt(result.orderCount);

      el('cost-hold').textContent = fmt(result.totalHoldCost);
      el('cost-orderfix').textContent = fmt(result.totalOrderFixCost);
      el('cost-orderunit').textContent = fmt(result.totalOrderUnitCost);
      el('cost-short').textContent = fmt(result.totalShortCost);
      el('cost-total').textContent = fmt(result.totalCost);

      // å›¾è¡¨
      renderChart(result, p.uom);

      // æ—¥å¿—ï¼ˆå±•ç¤ºæœ€è¿‘ 200 æ¡ï¼‰
      const tbody = el('logBody');
      tbody.innerHTML = '';
      const start = Math.max(0, result.logs.length - 200);
      for (let i = start; i < result.logs.length; i++) {
        const r = result.logs[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${r.day}</td>
          <td class="p-2">${r.demand}</td>
          <td class="p-2">${r.ship}</td>
          <td class="p-2">${r.short}</td>
          <td class="p-2">${r.receive}</td>
          <td class="p-2">${(r.order && r.order > 0) ? 'ä¸‹å•' : ''}</td>
          <td class="p-2">${r.invEnd}</td>
        `;
        tbody.appendChild(tr);
      }

      // ç¼“å­˜ç»“æœä»¥ä¾¿å¯¼å‡º
      window.__lastSim__ = { p, result };
    });

    el('btnExport').addEventListener('click', () => {
      const cache = window.__lastSim__;
      if (!cache) return alert('è¯·å…ˆè¿è¡Œä¸€æ¬¡ä»¿çœŸ');
      const { p, result } = cache;
      const rows = [
        ['day','demand','ship','short','receive','orderPlaced','invEnd']
      ];
      result.logs.forEach(r => {
        rows.push([r.day, r.demand, r.ship, r.short, r.receive, (r.order && r.order>0)?1:0, r.invEnd]);
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory_simulation.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // åˆå§‹æ¸…ç©º
    clearOutputs();
  </script>
</body>
</html>
